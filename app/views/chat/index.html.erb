<script type="text/javascript">
  Pusher.log = function(message) {
    if (window.console && window.console.log) window.console.log(message);
  };
  
  $(function() {
    // Set focus on message field
    $("#log_body").focus();
    
    var socket = new Pusher('9b398a15a5cdeb082e7d');
    var channel = socket.subscribe('presence-chat');

    channel.bind('pusher:subscription_succeeded', function(members) {
      console.log("subscribed!")
      update_member_count(members.count);
      members.each(function(member) {
        add_member(member.id, member.info);
      });
    });

    channel.bind('pusher:member_added', function(member) {
      console.log("added!")
    });

    channel.bind('pusher:member_removed', function(member) {
      console.log("removed!")
      remove_member(member.id);
    });
    
    channel.bind('comment', function(data) {
      console.log(data.user_name);
      $("<p>["+data.short_time+"] "+data.name+": "+data.body+"</p>").appendTo("#chat");
      $("#new_log").reset();
      $("#log_body").focus();
    });
    
  })
  
  function update_member_count(count) {
    $("#count").text(count + " users");
  }

  function add_member(member_id, member_info) {
    $("<li id='member_id_"+member_id+"'>"+member_info.name+"</li>").appendTo("#members");
  }

  function remove_member(member_id) {
    console.log("removing: " + member_id)
    console.log("removing!!." + $("member_id_" + member_id))
    $("#member_id_" + member_id).remove();
  }
</script>

<div style="background-color: white">
  
  <div id="chat">
  </div>

  <%= form_for Log.new, :remote => true do |f| %>
    <p>
      <%= f.text_field :body %>
      <%= f.submit "Send" %>
    </p>
  <% end %>

  <hr />

  <div id="count">Loading members count â€¦</div>

  <ul id="members">
  </ul>
</div>